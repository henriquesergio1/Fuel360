
version: '3.8'

services:
  fretes-api:
    build:
      context: ./api
      dockerfile: Dockerfile.txt
    container_name: fretes-api
    restart: unless-stopped
    ports:
      # Mapeia a porta 3000 do container para a porta 3030 do seu servidor.
      # Se a porta 3030 já estiver em uso no seu servidor, mude o primeiro número (ex: "3031:3000").
      - "3030:3000"
    
    # As variáveis de ambiente (senhas, etc.) devem ser configuradas diretamente
    # no Portainer ou em um arquivo .env na mesma pasta do docker-compose.
    environment:
      - API_PORT=3000
      # Segredo para assinatura de Tokens (Login e Licença). Mude isso em produção!
      - JWT_SECRET=${JWT_SECRET:-fretes-secret-key-change-in-prod}
      
      # Conexão Principal (Banco Fretes) - Padrão Novo
      - DB_SERVER_FRETE=${DB_SERVER_FRETE}
      - DB_DATABASE_FRETE=${DB_DATABASE_FRETE}
      - DB_USER_FRETE=${DB_USER_FRETE}
      - DB_PASSWORD_FRETE=${DB_PASSWORD_FRETE}

      # Fallback: Mantendo variáveis antigas (ODIN) para não quebrar configs salvas no Portainer
      - DB_SERVER_ODIN=${DB_SERVER_ODIN}
      - DB_DATABASE_ODIN=${DB_DATABASE_ODIN}
      - DB_USER_ODIN=${DB_USER_ODIN}
      - DB_PASSWORD_ODIN=${DB_PASSWORD_ODIN}
      
      # Conexão Legada (ERP)
      - DB_SERVER_ERP=${DB_SERVER_ERP}
      - DB_DATABASE_ERP=${DB_DATABASE_ERP}
      - DB_USER_ERP=${DB_USER_ERP}
      - DB_PASSWORD_ERP=${DB_PASSWORD_ERP}

  fretes-frontend:
    build:
      context: . # Constrói a imagem a partir da raiz do projeto
      dockerfile: Dockerfile.txt
    container_name: fretes-frontend
    restart: unless-stopped
    ports:
      # Mapeia a porta 80 do container para a porta 8080 do servidor.
      # Acesse o frontend em http://[IP_DO_SERVIDOR]:8080
      - "8080:80"
    depends_on:
      - fretes-api
